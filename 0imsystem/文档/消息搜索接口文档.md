# 悟空IM消息搜索接口文档

## 📋 接口概述

悟空IM提供了完整的消息搜索功能，支持多种搜索方式和消息类型。所有接口均为HTTP REST API，通过 `http://localhost:5001` 提供服务。

## ⚠️ 重要说明

**部分接口已被废弃，请使用新的推荐接口！**

| 接口状态 | 说明 |
|----------|------|
| ✅ **推荐使用** | 功能完整，持续维护 |
| ⚠️ **已废弃** | 功能受限，不推荐使用 |
| 🔄 **即将废弃** | 功能正常，但将被替代 |

## 🔍 可用搜索接口

### 1. 批量搜索消息接口 ✅

#### 接口信息
- **接口地址**: `POST /messages`
- **功能描述**: 批量搜索多条消息，支持按序列号、消息ID、客户端消息编号搜索
- **适用场景**: 需要获取多条消息详情的场景
- **状态**: ✅ **推荐使用**

#### 请求参数
```json
{
  "login_uid": "user001",                    // 登录用户ID（个人频道必需）
  "channel_id": "test_channel_001",          // 频道ID
  "channel_type": 2,                         // 频道类型：1-个人频道，2-群组频道
  "message_seqs": [1, 2, 3],                // 消息序列号数组（可选）
  "message_ids": [1957057726722871296],      // 消息ID数组（可选）
  "client_msg_nos": ["uuid1", "uuid2"]      // 客户端消息编号数组（可选）
}
```

#### 响应格式
```json
{
  "start_message_seq": 0,                   // 起始消息序列号
  "end_message_seq": 0,                     // 结束消息序列号
  "more": 0,                                // 是否还有更多消息：0-否，1-是
  "messages": [                              // 消息列表
    {
      "header": {                            // 消息头信息
        "red_dot": 0,                        // 红点标记：0-无，1-有
        "sync_once": 0,                      // 同步标记：0-普通，1-同步
        "no_persist": 0                      // 持久化标记：0-持久化，1-不持久化
      },
      "setting": 0,                          // 消息设置标志
      "message_id": 1957057726722871296,     // 消息ID
      "message_idstr": "1957057726722871296", // 消息ID字符串格式
      "client_msg_no": "uuid1",              // 客户端消息编号
      "message_seq": 1,                      // 消息序列号
      "from_uid": "user001",                 // 发送者ID
      "channel_id": "test_channel_001",      // 频道ID
      "channel_type": 2,                     // 频道类型
      "expire": 0,                           // 消息过期时间
      "timestamp": 1640995200,               // 消息时间戳（秒级Unix时间戳）
      "payload": "eyJ0eXBlIjogMSwgImNvbnRlbnQiOiAi5oKf56m6SU3mnI3liqHph43lkK/miJDlip/vvIEifQ=="  // 消息内容（Base64编码）
    }
  ]
}
```

#### 使用示例
```bash
curl -X POST http://localhost:5001/messages \
  -H "Content-Type: application/json" \
  -d '{
    "channel_id": "test_channel_001",
    "channel_type": 2,
    "message_ids": [1957057726722871296]
  }'
```

### 2. 单条消息搜索接口 ✅

#### 接口信息
- **接口地址**: `POST /message`
- **功能描述**: 搜索单条消息详情
- **适用场景**: 需要获取单条消息完整信息的场景
- **状态**: ✅ **推荐使用**

#### 请求参数
```json
{
  "channel_id": "test_channel_001",          // 频道ID
  "channel_type": 2,                         // 频道类型：1-个人频道，2-群组频道
  "message_id": 1957057726722871296          // 消息ID
}
```

#### 响应格式
```json
{
  "header": {                                // 消息头信息
    "red_dot": 0,                            // 红点标记
    "sync_once": 0,                          // 同步标记
    "no_persist": 0                          // 持久化标记
  },
  "setting": 0,                              // 消息设置标志
  "message_id": 1957057726722871296,         // 消息ID
  "message_idstr": "1957057726722871296",    // 消息ID字符串格式
  "client_msg_no": "uuid1",                  // 客户端消息编号
  "message_seq": 1,                          // 消息序列号
  "from_uid": "user001",                     // 发送者ID
  "channel_id": "test_channel_001",          // 频道ID
  "channel_type": 2,                         // 频道类型
  "expire": 0,                               // 消息过期时间
  "timestamp": 1640995200,                   // 消息时间戳（秒级Unix时间戳）
  "payload": "eyJ0eXBlIjogMSwgImNvbnRlbnQiOiAi5oKf56m6SU3mnI3liqHph43lkK/miJDlip/vvIEifQ=="  // 消息内容（Base64编码）
}
```

#### 使用示例
```bash
curl -X POST http://localhost:5001/message \
  -H "Content-Type: application/json" \
  -d '{
    "channel_id": "test_channel_001",
    "channel_type": 2,
    "message_id": 1957057726722871296
  }'
```

### 3. 消息同步接口 ✅ **推荐使用**

#### 接口信息
- **接口地址**: `POST /channel/messagesync`
- **功能描述**: 同步指定时间范围内的消息
- **适用场景**: 客户端离线后重新上线，需要同步历史消息
- **状态**: ✅ **推荐使用**

#### 请求参数
```json
{
  "login_uid": "user001",                    // 登录用户ID
  "channel_id": "test_channel_001",          // 频道ID
  "channel_type": 2,                         // 频道类型：1-个人频道，2-群组频道
  "start_message_seq": 0,                    // 起始消息序列号
  "end_message_seq": 100,                    // 结束消息序列号
  "limit": 50,                               // 返回消息数量限制（可选，默认50）
  "pull_mode": 0,                            // 拉取模式（可选）：0-向下拉取，1-向上拉取
  "stream_v2": 0                             // 是否使用stream_v2（可选）：0-否，1-是
}
```

#### 响应格式
```json
{
  "start_message_seq": 0,                   // 起始消息序列号
  "end_message_seq": 50,                    // 结束消息序列号
  "more": 1,                                // 是否还有更多消息：0-否，1-是
  "messages": [                              // 消息列表
    {
      "header": {                            // 消息头信息
        "red_dot": 0,                        // 红点标记
        "sync_once": 0,                      // 同步标记
        "no_persist": 0                      // 持久化标记
      },
      "setting": 0,                          // 消息设置标志
      "message_id": 1957057726722871296,     // 消息ID
      "message_idstr": "1957057726722871296", // 消息ID字符串格式
      "client_msg_no": "uuid1",              // 客户端消息编号
      "message_seq": 1,                      // 消息序列号
      "from_uid": "user001",                 // 发送者ID
      "channel_id": "test_channel_001",      // 频道ID
      "channel_type": 2,                     // 频道类型
      "expire": 0,                           // 消息过期时间
      "timestamp": 1640995200,               // 消息时间戳（秒级Unix时间戳）
      "payload": "eyJ0eXBlIjogMSwgImNvbnRlbnQiOiAi5oKf56m6SU3mnI3liqHph43lkK/miJDlip/vvIEifQ=="  // 消息内容（Base64编码）
    }
  ]
}
```

#### 使用示例
```bash
curl -X POST http://localhost:5001/channel/messagesync \
  -H "Content-Type: application/json" \
  -d '{
    "login_uid": "user001",
    "channel_id": "test_channel_001",
    "channel_type": 2,
    "start_message_seq": 0,
    "end_message_seq": 100,
    "limit": 50,
    "pull_mode": 0
  }'
```

### 4. 获取频道最大消息序号 ✅

#### 接口信息
- **接口地址**: `GET /channel/max_message_seq`
- **功能描述**: 获取指定频道的最大消息序号
- **适用场景**: 需要了解频道最新消息状态的场景
- **状态**: ✅ **推荐使用**

#### 请求参数
```
GET /channel/max_message_seq?channel_id=test_channel_001&channel_type=2
```

#### 响应格式
```json
{
  "message_seq": 6                           // 频道最大消息序号
}
```

#### 使用示例
```bash
curl "http://localhost:5001/channel/max_message_seq?channel_id=test_channel_001&channel_type=2"
```

## ⚠️ 已废弃接口（不推荐使用）

### 1. 旧消息同步接口 ❌ **已废弃**

#### 接口信息
- **接口地址**: `POST /message/sync`
- **功能描述**: 旧版消息同步接口
- **状态**: ❌ **已废弃，不推荐使用**
- **替代接口**: `POST /channel/messagesync`

#### 废弃原因
- 功能受限，仅支持个人频道
- 返回空数据，无法正常使用
- 已被新接口替代

#### 请求参数（仅供参考）
```json
{
  "uid": "user001",                          // 用户ID
  "message_seq": 0,                          // 消息序列号
  "limit": 10                                // 消息数量限制
}
```

### 2. 消息同步回执接口 ❌ **已废弃**

#### 接口信息
- **接口地址**: `POST /message/syncack`
- **功能描述**: 旧版消息同步回执接口
- **状态**: ❌ **已废弃，不推荐使用**

#### 废弃原因
- 功能已过时
- 不推荐在新项目中使用

## 📱 消息类型说明

### 支持的消息类型

| 类型值 | 消息类型 | 说明 | Payload结构 |
|--------|----------|------|-------------|
| 1 | 文本消息 | 普通文本内容 | `{"type": 1, "content": "消息内容"}` |
| 2 | 图片消息 | 图片文件 | `{"type": 2, "url": "图片地址", "width": 200, "height": 320}` |
| 3 | GIF消息 | 动态图片 | `{"type": 3, "url": "GIF地址", "width": 72, "height": 72}` |
| 4 | 语音消息 | 语音文件 | `{"type": 4, "url": "语音地址", "timeTrad": 10}` |
| 5 | 视频消息 | 视频文件 | `{"type": 5, "url": "视频地址", "width": 200, "height": 320, "timeTrad": 30}` |
| 6 | 位置消息 | 地理位置 | `{"type": 6, "latitude": 39.9, "longitude": 116.4, "title": "位置标题"}` |
| 7 | 名片消息 | 用户名片 | `{"type": 7, "uid": "用户ID", "name": "用户名", "avatar": "头像地址"}` |
| 8 | 文件消息 | 文件附件 | `{"type": 8, "url": "文件地址", "name": "文件名", "size": 1024}` |
| 9 | 链接消息 | 网页链接 | `{"type": 9, "url": "链接地址", "title": "链接标题", "desc": "链接描述"}` |
| 10 | 代码消息 | 代码片段 | `{"type": 10, "content": "代码内容", "language": "go"}` |
| 11 | 表情消息 | 表情符号 | `{"type": 11, "content": "😊"}` |

## 🔧 接口调用说明

### 基础配置
- **服务地址**: `http://localhost:5001`
- **协议**: HTTP/HTTPS
- **请求方式**: POST/GET
- **内容类型**: `application/json`
- **字符编码**: UTF-8

### 认证方式
当前配置中认证已关闭（`auth.on: false`），无需认证即可调用接口。

### 错误处理
接口调用失败时会返回相应的HTTP状态码和错误信息：

```json
{
  "error": "错误描述",
  "code": 400
}
```

### 常见状态码
- **200**: 请求成功
- **400**: 请求参数错误
- **404**: 资源不存在
- **500**: 服务器内部错误

## 📝 使用建议

### 1. 接口选择策略
- **消息搜索**: 使用 `/messages` 和 `/message` 接口
- **消息同步**: 使用 `/channel/messagesync` 接口（推荐）
- **状态查询**: 使用 `/channel/max_message_seq` 接口
- **避免使用**: 已废弃的 `/message/sync` 和 `/message/syncack` 接口

### 2. 性能优化
- 合理设置 `limit` 参数，避免一次性返回过多数据
- 使用 `message_ids` 进行精确搜索，性能最佳
- 避免频繁调用接口，建议实现本地缓存
- 使用 `pull_mode` 参数控制拉取方向

### 3. 错误处理
- 实现重试机制，处理网络异常
- 记录错误日志，便于问题排查
- 设置合理的超时时间

### 4. 数据解析
- Payload字段为Base64编码，需要解码后使用
- 注意处理不同消息类型的特殊字段
- **时间戳为秒级Unix时间戳**（不是毫秒级）

## 🚀 快速开始

### 1. 测试接口连通性
```bash
curl http://localhost:5001/health
```

### 2. 发送测试消息
```bash
# 编码消息内容
echo -n '{"type": 1, "content": "测试消息"}' | base64

# 发送消息
curl -X POST http://localhost:5001/message/send \
  -H "Content-Type: application/json" \
  -d '{
    "from_uid": "user001",
    "channel_id": "test_channel_001",
    "channel_type": 2,
    "payload": "eyJ0eXBlIjogMSwgImNvbnRlbnQiOiAi5rWL6K+V6K+36L6T5YWlIn0="
  }'
```

### 3. 同步消息
```bash
# 同步频道消息（推荐）
curl -X POST http://localhost:5001/channel/messagesync \
  -H "Content-Type: application/json" \
  -d '{
    "login_uid": "user001",
    "channel_id": "test_channel_001",
    "channel_type": 2,
    "start_message_seq": 0,
    "end_message_seq": 0,
    "limit": 10
  }'
```

### 4. 搜索消息
```bash
# 搜索单条消息
curl -X POST http://localhost:5001/message \
  -H "Content-Type: application/json" \
  -d '{
    "channel_id": "test_channel_001",
    "channel_type": 2,
    "message_id": "返回的消息ID"
  }'
```

## 📞 技术支持

如有问题，请检查：
1. 悟空IM服务是否正常运行
2. 接口地址和参数是否正确
3. 网络连接是否正常
4. 服务日志中的错误信息

## 🔄 接口更新历史

| 版本 | 更新内容 | 状态 |
|------|----------|------|
| v1.1 | 标记废弃接口，推荐新接口 | ✅ 当前版本 |
| v1.0 | 初始版本 | ❌ 已过时 |

---

**文档版本**: v1.1  
**更新时间**: 2024年12月  
**悟空IM版本**: v2.2.0  
**重要提醒**: 请使用推荐的接口，避免使用已废弃的接口！
