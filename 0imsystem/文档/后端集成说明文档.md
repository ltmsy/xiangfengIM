# 悟空IM 后端集成说明文档

## 概述

悟空IM提供了完整的后端集成方案，支持多种后端技术栈，包括Node.js、Python、Java、Go等。本文档详细说明如何在后端系统中集成悟空IM的即时通讯功能。

## 集成方式

### 1. HTTP REST API集成

#### 基础地址
- **开发环境**: `http://localhost:5001`
- **生产环境**: `https://your-domain.com`
- **内网地址**: 根据实际部署情况配置

#### 认证方式
- **Token认证**: 在请求头中添加 `Authorization: Bearer {token}`
- **JWT认证**: 支持JWT token认证
- **管理员认证**: 使用管理员token进行系统级操作

### 2. Webhook回调集成

#### 配置方式
- **HTTP回调**: 配置HTTP地址接收事件通知
- **gRPC回调**: 配置gRPC地址接收事件通知
- **事件过滤**: 可选择关注的事件类型

#### 支持的事件类型
- **msg.offline**: 离线消息事件
- **msg.notify**: 消息通知事件
- **user.onlinestatus**: 用户在线状态变化事件

### 3. 数据源集成

#### 自定义数据源
- **用户数据**: 对接现有用户系统
- **频道信息**: 对接现有频道/群组系统
- **权限控制**: 对接现有权限系统

## 核心功能接口

### 消息管理

#### 发送消息
- **接口**: `POST /message/send`
- **功能**: 发送单条消息到指定频道
- **业务场景**: 系统通知、客服回复、机器人消息等
- **参数说明**:
  - `channel_id`: 频道ID（必填）
  - `channel_type`: 频道类型（必填）
  - `content`: 消息内容（必填）
  - `type`: 消息类型（必填）
  - `from_uid`: 发送者UID（必填）
  - `client_msg_no`: 客户端消息编号（可选）

#### 批量发送消息
- **接口**: `POST /message/sendbatch`
- **功能**: 批量发送消息到多个频道
- **业务场景**: 群发通知、批量推送等
- **参数说明**: 消息数组，每条消息包含频道信息和内容

#### 消息搜索
- **接口**: `POST /messages`
- **功能**: 搜索频道内的消息
- **业务场景**: 消息审计、内容检索、历史查询等
- **参数说明**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `keyword`: 搜索关键词
  - `start_time`: 开始时间
  - `end_time`: 结束时间
  - `limit`: 返回数量限制

#### 消息同步
- **接口**: `POST /message/sync`
- **功能**: 同步频道消息（写模式）
- **业务场景**: 消息历史同步、离线消息处理等

### 频道管理

#### 创建/更新频道
- **接口**: `POST /channel`
- **功能**: 创建新频道或更新现有频道信息
- **业务场景**: 创建群聊、更新群信息、系统频道管理等
- **参数说明**:
  - `channel_id`: 频道ID（必填）
  - `channel_type`: 频道类型（必填）
  - `name`: 频道名称（必填）
  - `avatar`: 频道头像（可选）
  - `remark`: 频道备注（可选）
  - `extra`: 扩展信息（可选）

#### 删除频道
- **接口**: `POST /channel/delete`
- **功能**: 删除指定频道
- **业务场景**: 解散群聊、清理无效频道等
- **注意事项**: 删除后频道内所有数据将被清理

#### 频道信息管理
- **接口**: `POST /channel/info`
- **功能**: 更新或添加频道基础信息
- **业务场景**: 更新群公告、修改群设置等

#### 订阅者管理
- **添加订阅者**: `POST /channel/subscriber_add`
- **移除订阅者**: `POST /channel/subscriber_remove`
- **业务场景**: 邀请用户入群、踢出群成员、群成员管理等
- **参数说明**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `uids`: 用户ID数组

#### 权限管理
- **黑名单管理**:
  - 添加黑名单: `POST /channel/blacklist_add`
  - 设置黑名单: `POST /channel/blacklist_set`
  - 移除黑名单: `POST /channel/blacklist_remove`
- **白名单管理**:
  - 添加白名单: `POST /channel/whitelist_add`
  - 设置白名单: `POST /channel/whitelist_set`
  - 移除白名单: `POST /channel/whitelist_remove`
  - 获取白名单: `GET /channel/whitelist`

### 用户管理

#### 用户认证
- **更新Token**: `POST /user/token`
- **功能**: 更新用户的认证token
- **业务场景**: 用户重新登录、token刷新等
- **参数说明**:
  - `uid`: 用户ID（必填）
  - `token`: 新的token（必填）

#### 在线状态管理
- **获取在线状态**: `POST /user/onlinestatus`
- **功能**: 获取指定用户的在线状态
- **业务场景**: 用户状态查询、在线用户统计等
- **参数说明**:
  - `uids`: 用户ID数组（必填）

#### 设备管理
- **强制设备退出**: `POST /user/device_quit`
- **功能**: 强制指定用户的设备退出登录
- **业务场景**: 安全控制、多设备管理、异常处理等
- **参数说明**:
  - `uid`: 用户ID（必填）
  - `device_flag`: 设备标识（必填）

#### 系统用户管理
- **添加系统UID**: `POST /user/systemuids_add`
- **移除系统UID**: `POST /user/systemuids_remove`
- **获取系统UID**: `GET /user/systemuids`
- **业务场景**: 系统通知、机器人账号、特殊用户等

### 会话管理

#### 会话同步
- **同步会话**: `POST /conversation/sync`
- **功能**: 同步用户的最近会话列表
- **业务场景**: 用户登录后恢复会话状态、多设备同步等
- **参数说明**:
  - `uid`: 用户ID（必填）
  - `limit`: 返回数量限制（可选）

#### 消息同步
- **同步最近消息**: `POST /conversation/syncMessages`
- **功能**: 同步会话的最近消息
- **业务场景**: 消息历史加载、未读消息处理等
- **参数说明**:
  - `uid`: 用户ID（必填）
  - `channel_id`: 频道ID（必填）
  - `channel_type`: 频道类型（必填）
  - `limit`: 消息数量限制（可选）

#### 未读消息管理
- **清空未读数**: `POST /conversations/clearUnread`
- **设置未读数**: `POST /conversations/setUnread`
- **业务场景**: 消息已读处理、未读计数管理等

#### 会话操作
- **删除会话**: `POST /conversations/delete`
- **获取会话频道**: `POST /conversation/channels`
- **业务场景**: 会话清理、频道列表管理等

### 连接管理

#### 路由信息
- **获取连接地址**: `GET /route`
- **功能**: 获取用户所在节点的连接信息
- **业务场景**: 客户端连接、负载均衡等
- **参数说明**:
  - `intranet`: 是否返回内网地址（可选）

#### 批量路由
- **批量获取地址**: `POST /route/batch`
- **功能**: 批量获取多个用户所在节点的连接信息
- **业务场景**: 批量操作、系统集成等

### 流式消息

#### 流消息管理
- **创建流**: `POST /stream`
- **功能**: 创建流式消息（如AI对话）
- **业务场景**: AI助手、实时翻译、流式内容等
- **参数说明**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `from_uid`: 发送者UID
  - `content`: 初始内容

#### 流消息分块
- **添加分块**: `POST /stream/chunk`
- **功能**: 向流消息添加内容分块
- **业务场景**: 流式内容传输、实时数据推送等

## Webhook集成

### 配置说明

#### HTTP Webhook
```yaml
webhook:
  httpAddr: "http://your-app.com/webhook"
  msgNotifyEventPushInterval: 500ms
  msgNotifyEventRetryMaxCount: 5
  msgNotifyEventCountPerPush: 100
```

#### gRPC Webhook
```yaml
webhook:
  grpcAddr: "your-app.com:9090"
```

#### 事件过滤
```yaml
webhook:
  focusEvents:
    - "msg.offline"
    - "msg.notify"
    - "user.onlinestatus"
```

### 事件处理

#### 离线消息事件
- **事件类型**: `msg.offline`
- **触发时机**: 用户离线时收到消息
- **业务处理**: 存储离线消息、发送推送通知、更新未读计数等

#### 消息通知事件
- **事件类型**: `msg.notify`
- **触发时机**: 消息发送成功后
- **业务处理**: 消息日志记录、统计分析、业务逻辑触发等

#### 用户状态事件
- **事件类型**: `user.onlinestatus`
- **触发时机**: 用户在线状态发生变化
- **业务处理**: 状态同步、在线统计、业务逻辑触发等

## 数据源集成

### 自定义数据源配置

#### 用户数据源
```yaml
datasource:
  addr: "http://your-user-service.com"
  userInfoOn: true
```

#### 频道数据源
```yaml
datasource:
  channelInfoOn: true
```

### 数据源接口规范

#### 用户信息接口
- **接口**: `GET /user/info?uid={uid}`
- **返回格式**: JSON
- **必需字段**: uid, name, avatar
- **可选字段**: remark, extra

#### 频道信息接口
- **接口**: `GET /channel/info?channel_id={channel_id}&channel_type={channel_type}`
- **返回格式**: JSON
- **必需字段**: channel_id, channel_type, name
- **可选字段**: avatar, remark, extra

## 集群管理

### 集群状态监控

#### 节点信息
- **获取所有节点**: `GET /cluster/nodes`
- **获取当前节点**: `GET /cluster/node`
- **获取简单节点信息**: `GET /cluster/simpleNodes`

#### 槽位管理
- **获取槽信息**: `GET /cluster/slots`
- **获取所有槽**: `GET /cluster/allslot`
- **槽配置信息**: `GET /cluster/slots/{id}/config`

#### 频道管理
- **频道搜索**: `GET /cluster/channels`
- **频道配置**: `GET /cluster/channels/{channel_id}/{channel_type}/config`
- **频道状态**: `POST /cluster/channel/status`

### 性能监控

#### 连接统计
- **连接信息**: `GET /connz`
- **功能**: 获取当前连接统计信息
- **监控指标**: 连接数、消息数、流量等

#### 系统变量
- **系统变量**: `GET /varz`
- **功能**: 获取系统运行状态
- **监控指标**: 内存使用、CPU使用、GC状态等

#### 指标收集
- **Prometheus指标**: `GET /metrics`
- **功能**: 提供Prometheus格式的监控指标
- **集成方式**: 配置Prometheus抓取

## 安全配置

### 认证配置

#### JWT认证
```yaml
auth:
  on: true
  kind: 'jwt'
  users:
    - "admin:password:*"
    - "user:password:[*:r]"

jwt:
  secret: "your-secret-key"
  expire: 30d
```

#### 管理员认证
```yaml
managerToken: "your-manager-token"
```

### 访问控制

#### 白名单配置
```yaml
whitelistOffOfPerson: false
```

#### 权限管理
- **资源权限**: 支持细粒度权限控制
- **用户角色**: 支持不同用户角色配置
- **操作限制**: 支持读写权限分离

## 部署配置

### 环境配置

#### 开发环境
```yaml
mode: "debug"
pprofOn: true
logger:
  level: 1
  traceOn: true
```

#### 生产环境
```yaml
mode: "release"
pprofOn: false
logger:
  level: 2
  traceOn: false
```

### 网络配置

#### 端口配置
```yaml
addr: "tcp://0.0.0.0:5100"
httpAddr: "0.0.0.0:5001"
wsAddr: "ws://0.0.0.0:5200"
wssAddr: "wss://0.0.0.0:5210"
```

#### 外部访问配置
```yaml
external:
  ip: "your-public-ip"
  tcpAddr: "your-public-ip:5100"
  wsAddr: "ws://your-public-ip:5200"
  wssAddr: "wss://your-public-ip:5210"
```

## 集成最佳实践

### 架构设计

#### 分层架构
- **接入层**: 处理客户端连接和认证
- **业务层**: 处理业务逻辑和消息路由
- **存储层**: 处理消息持久化和数据存储
- **集成层**: 处理与现有系统的集成

#### 高可用设计
- **负载均衡**: 使用Nginx等负载均衡器
- **故障转移**: 配置多节点集群
- **监控告警**: 集成监控系统

### 性能优化

#### 消息处理
- **批量操作**: 使用批量接口减少请求次数
- **异步处理**: 非关键操作使用异步处理
- **缓存策略**: 合理使用缓存减少数据库压力

#### 连接管理
- **连接池**: 管理HTTP连接池
- **超时设置**: 合理设置请求超时时间
- **重试机制**: 实现请求重试和降级策略

### 安全考虑

#### 数据安全
- **传输加密**: 使用HTTPS/WSS协议
- **数据验证**: 验证所有输入数据
- **权限控制**: 实现细粒度权限控制

#### 系统安全
- **访问控制**: 限制API访问频率
- **日志记录**: 记录关键操作日志
- **异常处理**: 实现完善的异常处理机制

## 故障排查

### 常见问题

#### 连接问题
- **检查网络**: 确认网络连通性
- **检查端口**: 确认端口是否开放
- **检查防火墙**: 确认防火墙配置

#### 认证问题
- **检查Token**: 确认Token是否有效
- **检查权限**: 确认用户权限配置
- **检查配置**: 确认认证配置是否正确

#### 性能问题
- **检查资源**: 确认服务器资源使用情况
- **检查配置**: 确认性能相关配置
- **检查监控**: 查看性能监控指标

### 日志分析

#### 日志级别
- **Debug**: 详细的调试信息
- **Info**: 一般信息
- **Warn**: 警告信息
- **Error**: 错误信息

#### 关键日志
- **连接日志**: 记录连接建立和断开
- **消息日志**: 记录消息发送和接收
- **错误日志**: 记录系统错误和异常

## 技术支持

### 官方资源
- **官网**: https://githubim.com
- **文档**: https://githubim.com
- **GitHub**: https://github.com/WuKongIM/WuKongIM

### 社区支持
- **Issues**: https://github.com/WuKongIM/WuKongIM/issues
- **讨论**: 通过GitHub Issues进行技术讨论

### 版本兼容
- **建议版本**: 使用最新稳定版本
- **版本更新**: 关注版本更新和API变化
- **测试验证**: 在测试环境验证新功能
