# 悟空IM 前端集成说明文档

## 概述

悟空IM提供了完整的前端集成方案，支持Web、移动端H5、小程序等多种前端技术栈。本文档详细说明如何在前端应用中集成悟空IM的即时通讯功能。

## 集成方式

### 1. WebSocket长连接（实时通信）

#### 连接地址
- **普通WebSocket**: `ws://localhost:5200`
- **安全WebSocket**: `wss://localhost:5210`
- **生产环境**: 请使用您的实际服务器地址

#### 协议支持
- **二进制协议**: 高性能，适合移动端和Web端
- **JSON协议**: 易调试，适合Web端开发

### 2. HTTP REST API（业务操作）

#### 基础地址
- **开发环境**: `http://localhost:5001`
- **生产环境**: `https://your-domain.com`

#### 认证方式
- **Token认证**: 在请求头中添加 `Authorization: Bearer {token}`
- **JWT认证**: 支持JWT token认证

## 核心功能接口

### 消息管理

#### 发送消息
- **接口**: `POST /message/send`
- **功能**: 发送单条消息到指定频道
- **参数**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型（1:个人, 2:群聊, 3:客服, 4:社区）
  - `content`: 消息内容
  - `type`: 消息类型（text, image, file, audio, video等）
  - `from_uid`: 发送者UID

#### 批量发送消息
- **接口**: `POST /message/sendbatch`
- **功能**: 批量发送消息到多个频道
- **参数**: 消息数组

#### 搜索消息
- **接口**: `POST /messages`
- **功能**: 搜索频道内的消息
- **参数**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `keyword`: 搜索关键词
  - `limit`: 返回数量限制

### 频道管理

#### 创建/更新频道
- **接口**: `POST /channel`
- **功能**: 创建新频道或更新现有频道信息
- **参数**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `name`: 频道名称
  - `avatar`: 频道头像
  - `remark`: 频道备注

#### 删除频道
- **接口**: `POST /channel/delete`
- **功能**: 删除指定频道
- **参数**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型

#### 订阅者管理
- **添加订阅者**: `POST /channel/subscriber_add`
- **移除订阅者**: `POST /channel/subscriber_remove`
- **参数**:
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `uids`: 用户ID数组

#### 黑名单管理
- **添加黑名单**: `POST /channel/blacklist_add`
- **设置黑名单**: `POST /channel/blacklist_set`
- **移除黑名单**: `POST /channel/blacklist_remove`

#### 白名单管理
- **添加白名单**: `POST /channel/whitelist_add`
- **设置白名单**: `POST /channel/whitelist_set`
- **移除白名单**: `POST /channel/whitelist_remove`
- **获取白名单**: `GET /channel/whitelist`

### 用户管理

#### 更新用户Token
- **接口**: `POST /user/token`
- **功能**: 更新用户的认证token
- **参数**:
  - `uid`: 用户ID
  - `token`: 新的token

#### 获取在线状态
- **接口**: `POST /user/onlinestatus`
- **功能**: 获取指定用户的在线状态
- **参数**:
  - `uids`: 用户ID数组

#### 强制设备退出
- **接口**: `POST /user/device_quit`
- **功能**: 强制指定用户的设备退出登录
- **参数**:
  - `uid`: 用户ID
  - `device_flag`: 设备标识

### 会话管理

#### 同步会话
- **接口**: `POST /conversation/sync`
- **功能**: 同步用户的最近会话列表
- **参数**:
  - `uid`: 用户ID
  - `limit`: 返回数量限制

#### 同步最近消息
- **接口**: `POST /conversation/syncMessages`
- **功能**: 同步会话的最近消息
- **参数**:
  - `uid`: 用户ID
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `limit`: 消息数量限制

#### 清空未读数
- **接口**: `POST /conversations/clearUnread`
- **功能**: 清空指定会话的未读消息数
- **参数**:
  - `uid`: 用户ID
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型

#### 设置未读数
- **接口**: `POST /conversations/setUnread`
- **功能**: 设置指定会话的未读消息数
- **参数**:
  - `uid`: 用户ID
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型
  - `unread_count`: 未读数量

#### 删除会话
- **接口**: `POST /conversations/delete`
- **功能**: 删除指定会话
- **参数**:
  - `uid`: 用户ID
  - `channel_id`: 频道ID
  - `channel_type`: 频道类型

### 连接管理

#### 获取连接地址
- **接口**: `GET /route`
- **功能**: 获取用户所在节点的连接信息
- **参数**:
  - `intranet`: 是否返回内网地址（可选）

#### 批量获取连接地址
- **接口**: `POST /route/batch`
- **功能**: 批量获取多个用户所在节点的连接信息
- **参数**: 用户ID数组

## 消息类型说明

### 基础消息类型
- **text**: 文本消息
- **image**: 图片消息
- **file**: 文件消息
- **audio**: 音频消息
- **video**: 视频消息
- **location**: 位置消息

### 特殊消息类型
- **command**: 命令消息（不存储）
- **custom**: 自定义消息
- **stream**: 流式消息（如AI对话）

### 消息属性
- **message_id**: 消息唯一ID
- **message_seq**: 消息序号
- **client_msg_no**: 客户端消息编号
- **from_uid**: 发送者UID
- **channel_id**: 频道ID
- **channel_type**: 频道类型
- **content**: 消息内容
- **type**: 消息类型
- **timestamp**: 发送时间戳

## 频道类型说明

### 个人频道
- **类型值**: 1
- **说明**: 一对一私聊
- **特点**: 只有两个用户，自动创建

### 群聊频道
- **类型值**: 2
- **说明**: 多人聊天群
- **特点**: 支持群管理、权限控制

### 客服频道
- **类型值**: 3
- **说明**: 客服系统
- **特点**: 支持访客、客服分配

### 社区频道
- **类型值**: 4
- **说明**: 社区讨论
- **特点**: 公开频道，可订阅

## 错误码说明

### 成功响应
```json
{
  "status": "ok",
  "data": {}
}
```

### 错误响应
```json
{
  "status": "error",
  "message": "错误描述"
}
```

### 常见错误码
- **400**: 请求参数错误
- **401**: 认证失败
- **403**: 权限不足
- **404**: 资源不存在
- **500**: 服务器内部错误

## 集成步骤

### 1. 环境准备
- 确保悟空IM服务已启动
- 获取服务器地址和端口
- 准备用户认证信息

### 2. 建立连接
- 使用WebSocket建立长连接
- 发送连接认证信息
- 处理连接状态变化

### 3. 消息收发
- 监听消息接收事件
- 发送消息到指定频道
- 处理消息发送状态

### 4. 频道管理
- 创建和管理频道
- 管理频道订阅者
- 设置频道权限

### 5. 会话同步
- 同步用户会话列表
- 同步频道消息历史
- 管理未读消息状态

## 注意事项

### 性能优化
- 合理使用消息批量发送
- 控制消息同步频率
- 及时清理无用连接

### 安全考虑
- 使用HTTPS/WSS协议
- 验证消息来源
- 控制API访问频率

### 用户体验
- 实现消息发送状态提示
- 支持消息重发机制
- 优化网络异常处理

## 技术支持

### 官方资源
- **官网**: https://githubim.com
- **文档**: https://githubim.com
- **GitHub**: https://github.com/WuKongIM/WuKongIM

### 社区支持
- **Issues**: https://github.com/WuKongIM/WuKongIM/issues
- **讨论**: 通过GitHub Issues进行技术讨论

### 版本兼容
- 建议使用最新稳定版本
- 关注版本更新和API变化
- 测试环境验证新功能
